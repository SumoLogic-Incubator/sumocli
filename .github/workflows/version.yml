on:
  pull_request:
    types: closed
    branches: 
      - main

jobs:
  create_semver:
    name: Create Version
    runs-on: ubuntu-latest
    steps:
      - name: Create Tag
        id: semvertag
        uses: K-Phoen/semver-release-action@master
        with:
          release_branch: main
          release_strategy: tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      semvertag: ${{ steps.semvertag.outputs.tag }}

  create_github_release:
    name: Create GitHub Release
    needs: create_semver
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout/@v2
      - name: Update Go Application version information
        shell: pwsh
        run : |
          (Get-Content version/version.go).Replace("-version", "${{ steps.semvertag.outputs.tag }}") | Set-Content version/version.go
          (Get-Content version/version.go).Replace("-build", $Env:GITHUB_RUN_NUMBER) | Set-Content version/version.go
      - name: Create Release
        id: createrelease
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create_semver.outputs.semvertag }}
